<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Weather Forecast Aggregator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ cache_bust }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üå§Ô∏è Weather Forecast Aggregator</h1>
            <p class="subtitle">Real-time weather data from multiple global forecast APIs</p>
        </header>

        <div class="controls">
            <div class="location-search-wrapper">
                <div class="location-selector">
                    <span class="location-icon">üìç</span>
                    <input type="text"
                           id="location-search"
                           class="location-search-input"
                           placeholder="Search location..."
                           autocomplete="off">
                    <span class="dropdown-arrow">üîç</span>
                </div>
                <div id="location-dropdown" class="location-dropdown" style="display: none;"></div>
            </div>
            <button id="favorites-btn" class="favorites-btn" onclick="toggleFavorites()">
                <span class="favorites-icon">‚≠ê</span>
            </button>
            <button id="refresh-btn" class="refresh-btn" onclick="refreshForecast()">
                <span class="refresh-icon">üîÑ</span>
                <span class="refresh-text">Refresh</span>
            </button>
            <button id="support-btn" class="support-btn" onclick="toggleSupportPage()">
                <span class="support-icon">üèâ</span>
                <span class="support-text">Support us</span>
            </button>
        </div>

        <div id="favorites-panel" class="favorites-panel" style="display: none;">
            <h3>Favorite Locations</h3>
            <div id="favorites-list" class="favorites-list"></div>
        </div>

        <!-- Support AFL Israel Page -->
        <div id="support-page" class="support-page" style="display: none;">
            <div class="support-page-content">
                <!-- Hero Section -->
                <section class="support-hero">
                    <div class="support-hero-overlay"></div>
                    <div class="support-hero-content">
                        <h1>Support AFL Israel!</h1>
                        <p class="support-tagline">Seeing you consider to support us is warming our hearts!</p>
                        <p class="support-description">We are able to continue our journey of making AFL a well established sport in Israel with your support.</p>
                        <div class="support-recent-donors">
                            <span class="donors-label">Just one click:</span>
                            <div class="quick-donate-amounts">
                                <button class="quick-donate-btn" onclick="openDonationModal('general', 50)">$50</button>
                                <button class="quick-donate-btn" onclick="openDonationModal('general', 100)">$100</button>
                                <button class="quick-donate-btn" onclick="openDonationModal('general', 500)">$500</button>
                            </div>
                        </div>
                        <div class="recent-supporters">
                            <p>Recent supporters: Mike M. - "Wish you all the best!"</p>
                            <p>David Steineger - "Go Cheetahs!"</p>
                        </div>
                        <div class="thank-you-message">
                            <p>Thanks - AFL Israel!</p>
                        </div>
                    </div>
                </section>

                <!-- Campaigns Section -->
                <section class="campaigns-section">
                    <h2>Campaigns</h2>
                    <div class="campaigns-grid">
                        <!-- Eurocup 2025 -->
                        <div class="campaign-card">
                            <div class="campaign-image eurocup-2025"></div>
                            <div class="campaign-content">
                                <h3>Eurocup 2025</h3>
                                <p>After finishing 5th place in Eurocup 2024, we want more!</p>
                                <p>Help us get better results in Eurocup 2025, and become part of our journey!</p>
                                <button class="donate-btn" onclick="openDonationModal('eurocup2025')">DONATE</button>
                            </div>
                        </div>

                        <!-- Eurocup 2026 -->
                        <div class="campaign-card">
                            <div class="campaign-image eurocup-2026"></div>
                            <div class="campaign-content">
                                <h3>Eurocup 2026</h3>
                                <p>We look far and aim high!</p>
                                <p>Help us get to the top 3 teams in Eurocup 2026, and become part of our journey!</p>
                                <button class="donate-btn" onclick="openDonationModal('eurocup2026')">DONATE</button>
                            </div>
                        </div>

                        <!-- AFL Israel 2035 -->
                        <div class="campaign-card">
                            <div class="campaign-image afl-2035"></div>
                            <div class="campaign-content">
                                <h3>AFL Israel 2035</h3>
                                <p class="campaign-subtitle">Long Term Goal</p>
                                <p>A well established and recognized sport in Israel with a Stable Hub (Office, Stadium).</p>
                                <button class="donate-btn" onclick="openDonationModal('afl2035')">DONATE</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Groups Support Section -->
                <section class="groups-support-section">
                    <h2>Groups Support</h2>
                    <div class="groups-grid">
                        <div class="group-card">
                            <div class="group-icon">üêÜ</div>
                            <div class="group-content">
                                <h3>Support The Tel Aviv Cheetahs</h3>
                                <p>Support our men's team</p>
                            </div>
                            <button class="donate-btn small" onclick="openDonationModal('cheetahs')">DONATE</button>
                        </div>

                        <div class="group-card">
                            <div class="group-icon">üêù</div>
                            <div class="group-content">
                                <h3>Support The Tel Aviv Bees</h3>
                                <p>Support our women's team</p>
                            </div>
                            <button class="donate-btn small" onclick="openDonationModal('bees')">DONATE</button>
                        </div>

                        <div class="group-card">
                            <div class="group-icon">‚≠ê</div>
                            <div class="group-content">
                                <h3>Support The Tel Aviv Juniors</h3>
                                <p>Support our youth team</p>
                            </div>
                            <button class="donate-btn small" onclick="openDonationModal('juniors')">DONATE</button>
                        </div>
                    </div>
                </section>

                <!-- Help us train like pro's Section -->
                <section class="train-like-pros-section">
                    <h2>Help us train like pro's</h2>
                    <div class="equipment-grid">
                        <div class="equipment-card">
                            <div class="equipment-icon">üèüÔ∏è</div>
                            <div class="equipment-content">
                                <h3>Build Proper Pitches</h3>
                                <p>Help us build professional training facilities</p>
                            </div>
                            <button class="donate-btn small" onclick="openDonationModal('pitches')">DONATE</button>
                        </div>

                        <div class="equipment-card">
                            <div class="equipment-icon">üèà</div>
                            <div class="equipment-content">
                                <h3>Buy Better Equipment</h3>
                                <p>Quality balls, posts and training gear</p>
                            </div>
                            <button class="donate-btn small" onclick="openDonationModal('equipment')">DONATE</button>
                        </div>

                        <div class="equipment-card">
                            <div class="equipment-icon">üëï</div>
                            <div class="equipment-content">
                                <h3>Get New Kit/Gear</h3>
                                <p>New uniforms and protective gear</p>
                            </div>
                            <button class="donate-btn small" onclick="openDonationModal('gear')">DONATE</button>
                        </div>
                    </div>
                </section>

                <button class="back-to-weather-btn" onclick="toggleSupportPage()">
                    ‚Üê Back to Weather Forecast
                </button>
            </div>
        </div>

        <!-- Donation Modal -->
        <div id="donation-modal" class="donation-modal" style="display: none;">
            <div class="donation-modal-content">
                <button class="modal-close" onclick="closeDonationModal()">√ó</button>
                <h2 id="modal-title">Support Campaign</h2>
                <p id="modal-description">Choose your donation amount:</p>

                <div class="donation-tiers">
                    <div class="donation-tier" onclick="selectDonationTier(50)">
                        <span class="tier-name">Tackle donation</span>
                        <span class="tier-amount">$50</span>
                    </div>
                    <div class="donation-tier" onclick="selectDonationTier(100)">
                        <span class="tier-name">Goal donation</span>
                        <span class="tier-amount">$100</span>
                    </div>
                    <div class="donation-tier" onclick="selectDonationTier(500)">
                        <span class="tier-name">Speckie Donation</span>
                        <span class="tier-amount">$500</span>
                    </div>
                    <div class="donation-tier" onclick="selectDonationTier(1000)">
                        <span class="tier-name">Shoey Donation</span>
                        <span class="tier-amount">$1000</span>
                    </div>
                    <div class="donation-tier custom" onclick="showCustomAmount()">
                        <span class="tier-name">Other</span>
                        <span class="tier-amount">Custom</span>
                    </div>
                </div>

                <div id="custom-amount-section" class="custom-amount-section" style="display: none;">
                    <label for="custom-amount">Enter amount:</label>
                    <div class="custom-amount-input-wrapper">
                        <span class="currency-symbol">$</span>
                        <input type="number" id="custom-amount" min="1" placeholder="Enter amount">
                    </div>
                </div>

                <button id="proceed-donation-btn" class="proceed-donation-btn" onclick="proceedWithDonation()">
                    I want to support!
                </button>
            </div>
        </div>

        <div id="weather-alerts" class="weather-alerts" style="display: none;"></div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Fetching forecasts from all sources...</p>
            <div class="loading-progress">
                <div id="progress-sources" class="progress-sources"></div>
            </div>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="last-updated" class="last-updated" style="display: none;">
            Last updated: <span id="update-time"></span>
        </div>

        <div id="day-tabs" class="day-tabs" style="display: none;"></div>

        <div id="forecast-container">
            <div id="aggregated-forecast" class="forecast-section">
                <h2>üìä Aggregated Forecast</h2>
                <div id="aggregated-days" class="forecast-days"></div>
            </div>

            <div id="raw-data-section" style="display: none;">
                <button onclick="toggleRawData()" class="toggle-btn">üìã Show Individual Sources</button>
                <div id="raw-data" class="raw-data" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        let forecastData = null;
        let currentDayIndex = 0;
        let currentLocation = 'Tel Aviv';
        let favorites = JSON.parse(localStorage.getItem('weatherFavorites') || '[]');

        // Available cities worldwide (major cities)
        const availableCities = [
            // Israel
            'Tel Aviv', 'Jerusalem', 'Haifa', 'Beer Sheva', 'Eilat', 'Tiberias', 'Netanya', 'Ashdod',
            // North America
            'New York', 'Los Angeles', 'Chicago', 'Houston', 'Phoenix', 'Philadelphia', 'San Antonio', 'San Diego',
            'Dallas', 'San Jose', 'Austin', 'Jacksonville', 'Fort Worth', 'Columbus', 'Charlotte', 'San Francisco',
            'Seattle', 'Denver', 'Boston', 'Portland', 'Las Vegas', 'Miami', 'Atlanta', 'Toronto', 'Vancouver',
            'Montreal', 'Calgary', 'Ottawa', 'Mexico City', 'Guadalajara', 'Monterrey',
            // Europe
            'London', 'Paris', 'Berlin', 'Madrid', 'Rome', 'Barcelona', 'Vienna', 'Hamburg', 'Warsaw', 'Budapest',
            'Munich', 'Milan', 'Prague', 'Copenhagen', 'Stockholm', 'Brussels', 'Amsterdam', 'Athens', 'Lisbon',
            'Dublin', 'Oslo', 'Helsinki', 'Zurich', 'Geneva', 'Lyon', 'Marseille', 'Manchester', 'Birmingham',
            // Asia
            'Tokyo', 'Shanghai', 'Beijing', 'Mumbai', 'Delhi', 'Seoul', 'Jakarta', 'Manila', 'Bangkok', 'Singapore',
            'Hong Kong', 'Bangalore', 'Kuala Lumpur', 'Taipei', 'Dubai', 'Abu Dhabi', 'Riyadh', 'Doha', 'Istanbul',
            'Tehran', 'Baghdad', 'Karachi', 'Lahore', 'Dhaka', 'Hanoi', 'Ho Chi Minh City',
            // Australia & Oceania
            'Sydney', 'Melbourne', 'Brisbane', 'Perth', 'Adelaide', 'Auckland', 'Wellington',
            // South America
            'S√£o Paulo', 'Rio de Janeiro', 'Buenos Aires', 'Lima', 'Bogot√°', 'Santiago', 'Caracas', 'Montevideo',
            // Africa
            'Cairo', 'Lagos', 'Kinshasa', 'Johannesburg', 'Nairobi', 'Casablanca', 'Accra', 'Cape Town', 'Addis Ababa'
        ].sort();

        // Weather icon mapping based on conditions
        function getWeatherIcon(condition, cloudCover) {
            if (!condition) {
                // Fallback to cloud cover if no condition provided
                if (cloudCover !== null && cloudCover !== undefined) {
                    if (cloudCover < 20) return '‚òÄÔ∏è';
                    if (cloudCover < 50) return 'üå§Ô∏è';
                    if (cloudCover < 75) return '‚õÖ';
                    return '‚òÅÔ∏è';
                }
                return 'üå§Ô∏è';
            }

            const cond = condition.toLowerCase();
            if (cond.includes('clear') || cond.includes('sunny')) return '‚òÄÔ∏è';
            if (cond.includes('partly') || cond.includes('partial')) return 'üå§Ô∏è';
            if (cond.includes('cloud')) return '‚òÅÔ∏è';
            if (cond.includes('rain') || cond.includes('shower')) return 'üåßÔ∏è';
            if (cond.includes('thunder') || cond.includes('storm')) return '‚õàÔ∏è';
            if (cond.includes('snow') || cond.includes('blizzard')) return '‚ùÑÔ∏è';
            if (cond.includes('fog') || cond.includes('mist')) return 'üå´Ô∏è';
            if (cond.includes('wind')) return 'üí®';
            return 'üå§Ô∏è';
        }

        // Get weather description
        function getWeatherDescription(condition, cloudCover, precipProb) {
            if (condition) return condition;

            // Generate description from data
            let desc = '';
            if (cloudCover < 20) desc = 'Clear';
            else if (cloudCover < 50) desc = 'Partly Cloudy';
            else if (cloudCover < 75) desc = 'Mostly Cloudy';
            else desc = 'Overcast';

            if (precipProb && precipProb > 30) {
                desc += ' with rain likely';
            } else if (precipProb && precipProb > 10) {
                desc += ' with possible rain';
            }

            return desc;
        }

        // City search autocomplete
        function setupCitySearch() {
            const searchInput = document.getElementById('location-search');
            const dropdown = document.getElementById('location-dropdown');

            searchInput.value = currentLocation;

            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();

                if (query.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                const matches = availableCities.filter(city =>
                    city.toLowerCase().includes(query)
                );

                if (matches.length > 0) {
                    dropdown.innerHTML = matches.map(city => `
                        <div class="location-option ${favorites.includes(city) ? 'favorite' : ''}"
                             onclick="selectLocation('${city}')">
                            ${city}
                        </div>
                    `).join('');
                    dropdown.style.display = 'block';
                } else {
                    dropdown.style.display = 'none';
                }
            });

            searchInput.addEventListener('focus', function() {
                if (this.value.length > 0) {
                    searchInput.dispatchEvent(new Event('input'));
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.location-search-wrapper')) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function selectLocation(city) {
            currentLocation = city;
            document.getElementById('location-search').value = city;
            document.getElementById('location-dropdown').style.display = 'none';
            loadForecast();
        }

        // Favorites functionality
        function toggleFavorites() {
            const panel = document.getElementById('favorites-panel');
            const btn = document.getElementById('favorites-btn');

            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                btn.classList.add('active');
                updateFavoritesList();
            } else {
                panel.style.display = 'none';
                btn.classList.remove('active');
            }
        }

        function updateFavoritesList() {
            const list = document.getElementById('favorites-list');

            if (favorites.length === 0) {
                list.innerHTML = '<p style="color: #666;">No favorite locations yet. Add your current location to favorites!</p>';
                return;
            }

            list.innerHTML = favorites.map(city => `
                <div class="favorite-item" onclick="selectLocation('${city}')">
                    <span>üìç ${city}</span>
                    <span class="favorite-remove" onclick="event.stopPropagation(); removeFavorite('${city}')">‚úï</span>
                </div>
            `).join('');

            // Add current location button
            if (!favorites.includes(currentLocation)) {
                list.innerHTML += `
                    <div class="favorite-item" onclick="addFavorite('${currentLocation}')" style="background: rgba(102, 126, 234, 0.2); color: #667eea;">
                        <span>‚ûï Add ${currentLocation}</span>
                    </div>
                `;
            }
        }

        function addFavorite(city) {
            if (!favorites.includes(city)) {
                favorites.push(city);
                localStorage.setItem('weatherFavorites', JSON.stringify(favorites));
                updateFavoritesList();
            }
        }

        function removeFavorite(city) {
            favorites = favorites.filter(f => f !== city);
            localStorage.setItem('weatherFavorites', JSON.stringify(favorites));
            updateFavoritesList();
        }

        // Refresh forecast function
        async function refreshForecast() {
            const refreshBtn = document.getElementById('refresh-btn');
            refreshBtn.classList.add('refreshing');
            refreshBtn.disabled = true;

            // Clear cache by forcing new load
            forecastData = null;
            await loadForecast(true);

            refreshBtn.classList.remove('refreshing');
            refreshBtn.disabled = false;
        }

        // Create day tabs
        function createDayTabs(days) {
            const dayTabsContainer = document.getElementById('day-tabs');
            dayTabsContainer.innerHTML = '';
            dayTabsContainer.style.display = 'flex';

            days.forEach((day, index) => {
                const tab = document.createElement('div');
                tab.className = 'day-tab' + (index === currentDayIndex ? ' active' : '');
                tab.textContent = formatDate(day.date);
                tab.onclick = () => scrollToDay(index);
                dayTabsContainer.appendChild(tab);
            });
        }

        // Scroll to specific day
        function scrollToDay(index) {
            currentDayIndex = index;
            const dayCards = document.querySelectorAll('.day-card');
            if (dayCards[index]) {
                dayCards[index].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                updateActiveDayTab();
            }
        }

        // Update active day tab
        function updateActiveDayTab() {
            const tabs = document.querySelectorAll('.day-tab');
            tabs.forEach((tab, index) => {
                tab.classList.toggle('active', index === currentDayIndex);
            });
        }

        // Load forecast on page load
        window.onload = function() {
            setupCitySearch();
            loadForecast();
        };

        // Check for weather alerts
        function checkWeatherAlerts(data) {
            const alertsDiv = document.getElementById('weather-alerts');
            const alerts = [];

            data.aggregated.forEach(day => {
                // Check for high winds
                if (day.wind_speed && day.wind_speed > 50) {
                    alerts.push({
                        icon: 'üí®',
                        title: 'High Wind Warning',
                        description: `Strong winds expected on ${formatDate(day.date)} (${Math.round(day.wind_speed)} km/h)`
                    });
                }

                // Check for heavy rain probability
                if (day.precipitation_prob && day.precipitation_prob > 80) {
                    alerts.push({
                        icon: 'üåßÔ∏è',
                        title: 'Heavy Rain Expected',
                        description: `High chance of rain on ${formatDate(day.date)} (${Math.round(day.precipitation_prob)}%)`
                    });
                }

                // Check for extreme temperatures
                if (day.temp_high && day.temp_high > 35) {
                    alerts.push({
                        icon: 'üå°Ô∏è',
                        title: 'Heat Warning',
                        description: `Very hot temperatures on ${formatDate(day.date)} (${Math.round(day.temp_high)}¬∞C)`
                    });
                }

                if (day.temp_low && day.temp_low < 5) {
                    alerts.push({
                        icon: '‚ùÑÔ∏è',
                        title: 'Cold Warning',
                        description: `Cold temperatures on ${formatDate(day.date)} (${Math.round(day.temp_low)}¬∞C)`
                    });
                }
            });

            if (alerts.length > 0) {
                alertsDiv.innerHTML = alerts.map(alert => `
                    <div style="margin-bottom: ${alerts.length > 1 ? '10px' : '0'};">
                        <span class="alert-icon">${alert.icon}</span>
                        <span class="alert-title">${alert.title}:</span>
                        <span class="alert-description">${alert.description}</span>
                    </div>
                `).join('');
                alertsDiv.style.display = 'block';
            } else {
                alertsDiv.style.display = 'none';
            }
        }

        // Update loading progress
        function updateLoadingProgress() {
            const progressDiv = document.getElementById('progress-sources');
            const sources = ['Open-Meteo', '7Timer', 'OpenWeather', 'WeatherAPI'];

            progressDiv.innerHTML = sources.map(source => `
                <span class="source-status loading">${source}</span>
            `).join('');
        }

        async function loadForecast(forceRefresh = false) {
            const location = currentLocation;
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const forecastContainer = document.getElementById('forecast-container');

            // Show loading with progress
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            forecastContainer.style.display = 'none';
            updateLoadingProgress();

            try {
                // Initial request
                const response = await fetch(`/api/forecast?location=${encodeURIComponent(location)}`);
                const data = await response.json();

                if (data.status === 'success') {
                    // Data is cached and ready
                    displayForecast(data.data);
                } else {
                    // Data is loading, poll for status
                    pollStatus();
                }
            } catch (error) {
                showError('Failed to load forecast: ' + error.message);
            }
        }

        async function pollStatus() {
            const maxAttempts = 60; // 60 seconds max
            let attempts = 0;

            const interval = setInterval(async () => {
                attempts++;

                if (attempts > maxAttempts) {
                    clearInterval(interval);
                    showError('Timeout: Failed to fetch forecast data');
                    return;
                }

                try {
                    const response = await fetch('/api/status');
                    const data = await response.json();

                    if (data.status === 'ready') {
                        clearInterval(interval);
                        displayForecast(data.data);
                    }
                } catch (error) {
                    clearInterval(interval);
                    showError('Failed to check status: ' + error.message);
                }
            }, 1000); // Poll every second
        }

        function displayForecast(data) {
            const loadingDiv = document.getElementById('loading');
            const forecastContainer = document.getElementById('forecast-container');
            const aggregatedDays = document.getElementById('aggregated-days');
            const lastUpdated = document.getElementById('last-updated');
            const updateTime = document.getElementById('update-time');

            loadingDiv.style.display = 'none';
            forecastContainer.style.display = 'block';
            lastUpdated.style.display = 'block';
            updateTime.textContent = new Date().toLocaleString();

            forecastData = data;

            // Check for weather alerts
            checkWeatherAlerts(data);

            // Create day tabs
            createDayTabs(data.aggregated);

            // Display aggregated forecast
            aggregatedDays.innerHTML = '';
            data.aggregated.forEach(day => {
                const dayCard = createDayCard(day, true);
                aggregatedDays.appendChild(dayCard);
            });

            // Show raw data toggle if we have raw data
            if (data.raw && data.raw.length > 0) {
                document.getElementById('raw-data-section').style.display = 'block';
            }
        }

        function createDayCard(day, isAggregated) {
            const card = document.createElement('div');
            card.className = 'day-card';

            const confidence = isAggregated ? day.confidence : null;
            const confidenceClass = confidence ? getConfidenceClass(confidence) : '';

            // Get weather icon and description
            const weatherIcon = getWeatherIcon(day.weather_condition, day.cloud_cover);
            const weatherDesc = getWeatherDescription(day.weather_condition, day.cloud_cover, day.precipitation_prob);

            card.innerHTML = `
                <div class="day-header">
                    <div class="day-date">${formatDate(day.date)}</div>
                    ${isAggregated ? `<div class="confidence ${confidenceClass}">${Math.round(confidence)}% confidence</div>` : ''}
                </div>
                <div class="day-body">
                    <div class="weather-icon">${weatherIcon}</div>
                    <div class="weather-description">${weatherDesc}</div>
                    ${day.precipitation_prob !== null && day.precipitation_prob !== undefined ? `
                        <div class="detail-item" style="flex-direction: column; align-items: flex-start; grid-column: 1 / -1;">
                            <span style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span class="detail-icon">üíß</span>
                                <span class="detail-label">Rain:</span>
                                <span>${Math.round(day.precipitation_prob)}%</span>
                            </span>
                            <div class="precipitation-bar" style="width: 100%;">
                                <div class="precipitation-fill" style="width: ${day.precipitation_prob}%;"></div>
                            </div>
                        </div>
                    ` : ''}
                    <div class="temps">
                        <div class="temp-high">
                            <span class="temp-label">High</span>
                            <span class="temp-value">${day.temp_high ? Math.round(day.temp_high) + '¬∞C' : 'N/A'}</span>
                            ${day.feels_like_high ? `<span class="temp-label" style="font-size: 0.8em; margin-top: 4px;">Feels ${Math.round(day.feels_like_high)}¬∞C</span>` : ''}
                        </div>
                        <div class="temp-low">
                            <span class="temp-label">Low</span>
                            <span class="temp-value">${day.temp_low ? Math.round(day.temp_low) + '¬∞C' : 'N/A'}</span>
                            ${day.feels_like_low ? `<span class="temp-label" style="font-size: 0.8em; margin-top: 4px;">Feels ${Math.round(day.feels_like_low)}¬∞C</span>` : ''}
                        </div>
                    </div>
                    <div class="details">
                        <div class="detail-item">
                            <span class="detail-icon">üí®</span>
                            <span class="detail-label">Wind:</span>
                            <span>${day.wind_speed ? Math.round(day.wind_speed) + ' km/h' : 'N/A'} ${day.wind_direction || ''}</span>
                        </div>
                        ${day.humidity !== null && day.humidity !== undefined ? `
                        <div class="detail-item">
                            <span class="detail-icon">üíß</span>
                            <span class="detail-label">Humidity:</span>
                            <span>${Math.round(day.humidity)}%</span>
                        </div>
                        ` : ''}
                        <div class="detail-item">
                            <span class="detail-icon">‚òÅÔ∏è</span>
                            <span class="detail-label">Cloud Cover:</span>
                            <span>${day.cloud_cover ? formatCloudCover(day.cloud_cover, day.cloud_min_level) : 'N/A'}</span>
                        </div>
                        ${day.freezing_altitude ? `
                        <div class="detail-item">
                            <span class="detail-icon">‚ùÑÔ∏è</span>
                            <span class="detail-label">Freezing Level:</span>
                            <span>${Math.round(day.freezing_altitude)}m</span>
                        </div>
                        ` : ''}
                        <div class="detail-item">
                            <span class="detail-icon">üåÖ</span>
                            <span class="detail-label">Sunrise:</span>
                            <span>${day.sunrise || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-icon">üåá</span>
                            <span class="detail-label">Sunset:</span>
                            <span>${day.sunset || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-icon">üåî</span>
                            <span class="detail-label">Moonrise:</span>
                            <span>${day.moonrise || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-icon">üåë</span>
                            <span class="detail-label">Moonset:</span>
                            <span>${day.moonset || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-icon">üåô</span>
                            <span class="detail-label">Moon Phase:</span>
                            <span>${day.moon_illumination ? Math.round(day.moon_illumination) + '%' : 'N/A'}</span>
                        </div>
                    </div>
                    ${day.hourly && day.hourly.length > 0 ? `
                    <div class="hourly-section">
                        <button class="hourly-toggle" onclick="toggleHourly(this)">
                            üìä Show 3-Hourly Forecast ‚ñº
                        </button>
                        <div class="hourly-data" style="display: none;">
                            <div class="hourly-grid">
                                ${day.hourly.map(h => `
                                    <div class="hourly-item">
                                        <div class="hourly-time">${h.time}</div>
                                        ${h.weather_condition ? `<div style="text-align: center; font-size: 1.5em; margin: 5px 0;">${getWeatherIcon(h.weather_condition, h.cloud_cover)}</div>` : ''}
                                        <div class="hourly-detail">
                                            <span class="hourly-icon">üå°Ô∏è</span>
                                            <span>${h.temperature ? Math.round(h.temperature) + '¬∞C' : 'N/A'}</span>
                                        </div>
                                        ${h.feels_like ? `
                                        <div class="hourly-detail">
                                            <span class="hourly-icon">ü§ö</span>
                                            <span>Feels ${Math.round(h.feels_like)}¬∞C</span>
                                        </div>
                                        ` : ''}
                                        ${h.precipitation_prob !== null && h.precipitation_prob !== undefined ? `
                                        <div class="hourly-detail">
                                            <span class="hourly-icon">üíß</span>
                                            <span>${Math.round(h.precipitation_prob)}% rain</span>
                                        </div>
                                        ` : ''}
                                        ${h.humidity !== null && h.humidity !== undefined ? `
                                        <div class="hourly-detail">
                                            <span class="hourly-icon">üí¶</span>
                                            <span>${Math.round(h.humidity)}% humid</span>
                                        </div>
                                        ` : ''}
                                        <div class="hourly-detail">
                                            <span class="hourly-icon">üí®</span>
                                            <span>${h.wind_speed ? Math.round(h.wind_speed) + ' km/h' : 'N/A'} ${h.wind_direction || ''}</span>
                                        </div>
                                        <div class="hourly-detail">
                                            <span class="hourly-icon">‚òÅÔ∏è</span>
                                            <span>${h.cloud_cover !== null && h.cloud_cover !== undefined ? (Math.round(h.cloud_cover / 12.5) + '/8' + (h.cloud_base && h.cloud_base > 0 ? ' alt ' + Math.round(h.cloud_base * 3.28084).toLocaleString() + ' ft' : '')) : 'N/A'}</span>
                                        </div>
                                        ${h.freezing_altitude ? `
                                        <div class="hourly-detail">
                                            <span class="hourly-icon">‚ùÑÔ∏è</span>
                                            <span>${Math.round(h.freezing_altitude)}m</span>
                                        </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    ${isAggregated && day.sources_used ? `
                    <div class="sources">
                        Sources: ${day.sources_used.join(', ')}
                    </div>
                    ` : ''}
                    ${!isAggregated && day.source ? `
                    <div class="source-badge">${day.source}</div>
                    ` : ''}
                </div>
            `;

            return card;
        }

        function formatCloudCover(cloudPercent, cloudBase) {
            // Convert percentage to octas (eighths)
            const octas = Math.round(cloudPercent / 12.5);
            let result = `${octas}/8`;

            // Add altitude only if real data available (not estimated)
            if (cloudBase && cloudBase > 0) {
                const altitudeFt = Math.round(cloudBase * 3.28084);
                result += ` alt ${altitudeFt.toLocaleString()} ft`;
            }

            return result;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === tomorrow.toDateString()) {
                return 'Tomorrow';
            } else {
                return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            }
        }

        function getConfidenceClass(confidence) {
            if (confidence >= 80) return 'high';
            if (confidence >= 60) return 'medium';
            return 'low';
        }

        function toggleRawData() {
            const rawDataDiv = document.getElementById('raw-data');
            const toggleBtn = document.querySelector('.toggle-btn');

            if (rawDataDiv.style.display === 'none') {
                // Show raw data
                rawDataDiv.style.display = 'block';
                toggleBtn.textContent = 'üìã Hide Individual Sources';

                // Populate raw data
                rawDataDiv.innerHTML = '<h3>Individual Source Forecasts</h3>';
                const sources = {};

                // Group by source
                forecastData.raw.forEach(day => {
                    if (!sources[day.source]) {
                        sources[day.source] = [];
                    }
                    sources[day.source].push(day);
                });

                // Display each source
                Object.entries(sources).forEach(([source, days]) => {
                    const sourceSection = document.createElement('div');
                    sourceSection.className = 'source-section';
                    sourceSection.innerHTML = `<h4>${source}</h4><div class="forecast-days"></div>`;

                    const daysContainer = sourceSection.querySelector('.forecast-days');
                    days.forEach(day => {
                        const dayCard = createDayCard(day, false);
                        daysContainer.appendChild(dayCard);
                    });

                    rawDataDiv.appendChild(sourceSection);
                });
            } else {
                rawDataDiv.style.display = 'none';
                toggleBtn.textContent = 'üìã Show Individual Sources';
            }
        }

        function toggleHourly(button) {
            const hourlyData = button.nextElementSibling;
            if (hourlyData.style.display === 'none') {
                hourlyData.style.display = 'block';
                button.textContent = 'üìä Hide 3-Hourly Forecast ‚ñ≤';
            } else {
                hourlyData.style.display = 'none';
                button.textContent = 'üìä Show 3-Hourly Forecast ‚ñº';
            }
        }

        function showError(message) {
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');

            loadingDiv.style.display = 'none';
            errorDiv.style.display = 'block';
            errorDiv.textContent = message;
        }

        // Support Page Functions
        let selectedDonationAmount = 0;
        let currentCampaign = 'general';

        function toggleSupportPage() {
            const supportPage = document.getElementById('support-page');
            const supportBtn = document.getElementById('support-btn');
            const forecastContainer = document.getElementById('forecast-container');
            const dayTabs = document.getElementById('day-tabs');
            const lastUpdated = document.getElementById('last-updated');
            const weatherAlerts = document.getElementById('weather-alerts');
            const favoritesPanel = document.getElementById('favorites-panel');
            const controls = document.querySelector('.controls');
            const header = document.querySelector('header');

            if (supportPage.style.display === 'none') {
                // Show support page
                supportPage.style.display = 'block';
                supportBtn.classList.add('active');
                forecastContainer.style.display = 'none';
                dayTabs.style.display = 'none';
                lastUpdated.style.display = 'none';
                weatherAlerts.style.display = 'none';
                favoritesPanel.style.display = 'none';

                // Update header for support page
                header.querySelector('h1').innerHTML = 'üèâ AFL Israel';
                header.querySelector('.subtitle').textContent = 'Australian Football League Israel';
            } else {
                // Show weather page
                supportPage.style.display = 'none';
                supportBtn.classList.remove('active');
                forecastContainer.style.display = 'block';
                if (forecastData && forecastData.aggregated) {
                    dayTabs.style.display = 'flex';
                    lastUpdated.style.display = 'block';
                }

                // Restore header
                header.querySelector('h1').innerHTML = 'üå§Ô∏è Weather Forecast Aggregator';
                header.querySelector('.subtitle').textContent = 'Real-time weather data from multiple global forecast APIs';
            }
        }

        const campaignTitles = {
            'general': 'Support AFL Israel',
            'eurocup2025': 'Eurocup 2025 Campaign',
            'eurocup2026': 'Eurocup 2026 Campaign',
            'afl2035': 'AFL Israel 2035 Vision',
            'cheetahs': 'Tel Aviv Cheetahs',
            'bees': 'Tel Aviv Bees',
            'juniors': 'Tel Aviv Juniors',
            'pitches': 'Build Proper Pitches',
            'equipment': 'Buy Better Equipment',
            'gear': 'Get New Kit/Gear'
        };

        const campaignDescriptions = {
            'general': 'Your donation helps us grow AFL in Israel!',
            'eurocup2025': 'Help us compete in Eurocup 2025!',
            'eurocup2026': 'Support our journey to top 3 in Eurocup 2026!',
            'afl2035': 'Help build a lasting legacy for AFL in Israel!',
            'cheetahs': 'Support our men\'s team!',
            'bees': 'Support our women\'s team!',
            'juniors': 'Support our youth development program!',
            'pitches': 'Help us build professional training facilities!',
            'equipment': 'Help us get quality training equipment!',
            'gear': 'Help us get new uniforms and gear!'
        };

        function openDonationModal(campaign, presetAmount = null) {
            currentCampaign = campaign;
            const modal = document.getElementById('donation-modal');
            const title = document.getElementById('modal-title');
            const description = document.getElementById('modal-description');

            title.textContent = campaignTitles[campaign] || 'Support AFL Israel';
            description.textContent = campaignDescriptions[campaign] || 'Choose your donation amount:';

            // Reset selection
            document.querySelectorAll('.donation-tier').forEach(tier => tier.classList.remove('selected'));
            document.getElementById('custom-amount-section').style.display = 'none';
            selectedDonationAmount = 0;

            if (presetAmount) {
                selectedDonationAmount = presetAmount;
                // Find and select the matching tier
                document.querySelectorAll('.donation-tier').forEach(tier => {
                    const amountText = tier.querySelector('.tier-amount').textContent;
                    if (amountText === `$${presetAmount}`) {
                        tier.classList.add('selected');
                    }
                });
            }

            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeDonationModal() {
            const modal = document.getElementById('donation-modal');
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }

        function selectDonationTier(amount) {
            selectedDonationAmount = amount;
            document.querySelectorAll('.donation-tier').forEach(tier => tier.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            document.getElementById('custom-amount-section').style.display = 'none';
        }

        function showCustomAmount() {
            document.querySelectorAll('.donation-tier').forEach(tier => tier.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            document.getElementById('custom-amount-section').style.display = 'block';
            document.getElementById('custom-amount').focus();
            selectedDonationAmount = 0;
        }

        function proceedWithDonation() {
            const customAmountInput = document.getElementById('custom-amount');
            if (document.getElementById('custom-amount-section').style.display !== 'none') {
                selectedDonationAmount = parseInt(customAmountInput.value) || 0;
            }

            if (selectedDonationAmount <= 0) {
                alert('Please select or enter a donation amount');
                return;
            }

            // Show thank you message (in a real app, this would redirect to payment)
            alert(`Thank you for your $${selectedDonationAmount} donation to ${campaignTitles[currentCampaign]}!\n\nIn a real implementation, this would redirect to a payment processor.`);
            closeDonationModal();
        }

        // Close modal on background click
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('donation-modal');
            if (e.target === modal) {
                closeDonationModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDonationModal();
            }
        });
    </script>
</body>
</html>
